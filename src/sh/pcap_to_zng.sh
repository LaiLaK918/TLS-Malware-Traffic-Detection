#!/bin/bash

# Convert all pcap files from source to zng in dest
source_folder=$1
destination_folder=$2

# Check if both the source folder and destination folder are provided
if [ -z "$source_folder" ] || [ -z "$destination_folder" ]; then
    echo "Usage: $0 <source_folder> <destination_folder>"
    exit 1
fi

# Create the destination folder if it doesn't exist
if [ ! -d "$destination_folder" ]; then
    mkdir -p "$destination_folder"
fi

# Get all pcap files in the source directory
pcap_files=("$source_folder"/*.pcap)

# Debug
# printf '%s\n' "${pcap_files[@]}"

# Loop through each pcap file and run brimcap
for pcap_file in "${pcap_files[@]}"; do
    # Extract the base name without extension
    base_name=$(basename -s .pcap "$pcap_file")

    # Construct the output file path with .zng extension in the destination folder
    output_file="$destination_folder/$base_name.zng"

    # Check if the .zng file already exists, and skip the loop if it does
    if [ -e "$output_file" ]; then
        echo "Skipping $base_name. The corresponding .zng file already exists."
        continue
    fi

    # Construct the command to run brimcap
    echo "Analyzing $pcap_file..."
    brimcap analyze -o "$output_file" "$pcap_file"

    echo -e "$pcap_file analyzed successfully!\n\n"
done
