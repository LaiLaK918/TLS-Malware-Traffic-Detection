import pandas as pd
import numpy as np
import ast
import sys

if __name__ == '__main__':
    if len(sys.argv) < 5:
        print("Usage: python3 merge_csv.py <conn> <ssl> <x509>")
        exit(0)
    conn_path = sys.argv[1]
    ssl_path = sys.argv[2]
    x509_path = sys.argv[3]
    save_path = sys.argv[4]
    mcfp_normal_x509 = pd.read_csv(x509_path)
    mcfp_normal_ssl = pd.read_csv(ssl_path)
    mcfp_normal_conn = pd.read_csv(conn_path)
    
    # 'uid' is the common column in conn and ssl
    merged_conn_ssl = pd.merge(mcfp_normal_conn, mcfp_normal_ssl, how='inner', on='uid')

    mcfp_normal_ssl['cert_chain_fuids'] = mcfp_normal_ssl['cert_chain_fuids'].apply(lambda x: ast.literal_eval(x)[0] if pd.notnull(x) else None)
    
    # 'cert_chain_fuids' is the common column between ssl and x509
    merged_ssl_x509 = pd.merge(mcfp_normal_ssl, mcfp_normal_x509, how='inner', left_on='cert_chain_fuids', right_on='id')

    # merge conn, ssl, and x509 into a single DataFrame
    merged_conn_ssl_x509 = pd.merge(merged_conn_ssl, merged_ssl_x509, how='inner', on='uid')

    print(merged_conn_ssl_x509.info())
    merged_conn_ssl_x509.to_csv(save_path, index=False)
